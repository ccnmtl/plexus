{% extends 'base.html' %}
{% load feeds %}
{% load inplace_edit %}

{% block content %}

<h1>Application: {% inplace_edit "application.name" %}</h1>
{% if request.user.is_staff %}
<a href="/admin/main/application/{{application.id}}/">edit</a>
{% endif %}

<table class="table table-striped table-condensed table-bordered">
	<tr>
		<td>description</td>
		<td>{% inplace_edit "application.description" %}</td>
	</tr>
	<tr><td>technology</td><td>{% inplace_edit "application.technology" %}</td></tr>
	{% if application.pmt_id %}
	<tr>
		<td>PMT</td>
		<td>
			<a href="http://pmt.ccnmtl.columbia.edu/home.pl?mode=project;pid={{application.pmt_id}}">Project Page</a>
			[<a href="http://pmt.ccnmtl.columbia.edu/home.pl?mode=add_item_form;type=bug;pid={{application.pmt_id}}">report bug</a>]
			[<a href="http://pmt.ccnmtl.columbia.edu/home.pl?mode=add_item_form;type=action;pid={{application.pmt_id}}">add
			action item</a>]
		</td>
	</tr>
	{% endif %}
	{% if application.sentry_name %}
	<tr>
		<td>Sentry</td>
		<td><a href="http://sentry.ccnmtl.columbia.edu/sentry/?server_name=&amp;site={{application.sentry_name}}">View Errors</a></td>
	</tr>
	{% endif %}
	<tr>
		<td>Contacts</td>
		<td>
			{% for ac in application.applicationcontact_set.all %}
			<a href="/contact/{{ac.contact.id}}/">{{ac.contact.name}}</a>
			{% endfor %}
		</td>
	</tr>

</table>

{% if application.applicationalias_set.count %}
<h2>Alias(es)</h2>
<ul>
{% for aa in application.applicationalias_set.all %}
<li><a href="/alias/{{aa.alias.id}}/">{{aa.alias.hostname}}</a></li>
{% endfor %}
</ul>
{% endif %}


{% if application.graphite_name %}
<h2>Smoketests</h2>
<div id="smoketests">passed/run</div>


<h2>Graphs</h2>
<ul class="nav nav-tabs">
  <li><a href="#daily" data-toggle="tab">Daily</a></li>
  <li><a href="#weekly" data-toggle="tab">Weekly</a></li>
  <li><a href="#monthly" data-toggle="tab">Monthly</a></li>
  <li><a href="#yearly" data-toggle="tab">Yearly</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="daily">
    <div id="graphs-daily"></div>
  </div>

  <div class="tab-pane" id="weekly">
    <div id="graphs-weekly"></div>
  </div>

  <div class="tab-pane" id="monthly">
    <div id="graphs-monthly"></div>
  </div>
  <div class="tab-pane" id="yearly">
    <div id="graphs-yearly"></div>
  </div>
</div>
{% endif %}

{% if application.pmt_id %}
<h2>Recent PMT Activity</h2>
{% parse_feed application.pmt_feed_url as pmt_feed %}
{% for item in pmt_feed.entries %}
<h4><a href="{{item.link}}">{{item.title}}</a></h4>
{{item.description|safe}}
{% endfor %}


{% endif %}


{% endblock %}

{% block js %}
{% if application.graphite_name %}
<script src="/site_media/js/d3.v2.min.js"></script>
<script src="/site_media/js/cubism.v1.min.js"></script>
<script src="/site_media/js/smoketests.js"></script>
<script>

var makegraphs = function (el, graphite_name, size, step) {
var context = cubism.context(), // a default context
      graphite = context.graphite("");
  
  context.size(size).step(step);

  var counter_base = "ccnmtl.app.counters." + graphite_name; 
  var timer_base = "ccnmtl.app.timers." + graphite_name;

  
  var metric_defs = [
    {
      metric: counter_base + ".response.200",
      alias: "Requests"
    },
    {
      metric: timer_base + ".view.GET.mean",
      alias: "request time (mean)"
    },
    {
      metric: timer_base + ".view.GET.lower",
      alias: "request time (lower)"
    },
    {
      metric: timer_base + ".view.GET.upper",
      alias: "request time (max)"
    },
    {
      metric: counter_base + ".response.500",
      alias: "500s"
    },
    {
      metric: counter_base + ".response.404",
      alias: "404s"
    }
  ];
  
  var gmetric = function(metric_def) {
     return graphite.metric(metric_def.metric).alias(metric_def.alias);
  };
  
  var metrics = metric_defs.map(gmetric);

  var oranges = ["#08519c", "#*82bd", "#6baed6",
                 "#fee6ce", "#fdae6b", "#e6550d" ];
  var greens = ["#edf8b8", "#b2e2e2", "#66c2a4",
                "#2ca25f", "#006d2c" ];
  var blues = ["#eff3ff", "#c6dbef", "#9ecae1",
               "#6baed6", "#3182bd", "#08519c"];
  
  d3.select(el).call(function(div) {
    div.append("div")
        .attr("class", "axis")
        .call(context.axis().orient("top"));

    div.append("div")
      .datum(metrics[0])
      .attr("class", "horizon")
      .call(context.horizon()
        .height(100)
        .colors(greens)
        );
    div.append("div")
      .datum(metrics[1])
      .attr("class", "horizon")
      .call(context.horizon()
        .height(120)
        .colors(oranges)
        );
    div.append("div")
      .datum(metrics[1].subtract(metrics[2]))
      .attr("class", "horizon")
      .call(context.horizon()
        .height(30)
        .colors(blues)
        );
    div.append("div")
      .datum(metrics[3].subtract(metrics[1]))
      .attr("class", "horizon")
      .call(context.horizon()
        .height(30)
        .colors(greens)
        );
    div.append("div")
      .datum(metrics[4])
      .attr("class", "horizon")
      .call(context.horizon()
        .height(60)
        .colors(oranges)
        );
    div.append("div")
      .datum(metrics[5])
      .attr("class", "horizon")
      .call(context.horizon()
        .height(60)
        .colors(greens)
        );
  });
};

(function () {
  var width = $("#graphs-daily").width();
  window.makegraphs("#graphs-daily", "{{application.graphite_name}}", width, 1e5);
  window.makegraphs("#graphs-weekly", "{{application.graphite_name}}", width, 7e5);
  window.makegraphs("#graphs-monthly", "{{application.graphite_name}}", width, 30e5);
  window.makegraphs("#graphs-yearly", "{{application.graphite_name}}", width, 365e5);
  window.makesmoketests("#smoketests", "{{application.graphite_name}}");
}());
</script>
{% endif %}
{% endblock %}
