{% extends 'base.html' %}
{% load markup %}

{% block content %}

<h1>Server: {{ object.name }}</h1>
{% if request.user.is_staff %}
<a href="/server/{{object.id}}/edit/">edit</a>
{% endif %}

{% if object.deprecated %}
<div class="alert alert-error">
<h2>Deprecated</h2>

<p>This server has been deprecated.</p>

</div>
{% endif %}

<table class="table table-striped table-condensed table-bordered">
    <tr>
        <td>primary function</td>
        <td>{{ object.primary_function }}</td>
    </tr>
    {% if object.ec2_instance_id %}
    <tr>
        <td>EC2 Instance ID</td>
        <td>{{ object.ec2_instance_id }}</td>
    </tr>
    {% endif %}
    <tr><td>ip addresses</td>
        <td>
            {% for ip in object.ipaddress_set.all %}
            <code>{{ ip.ipv4 }}</code>{% if ip.mac_addr %} [<code>{{ ip.mac_addr }}</code>]{% endif %}
            {% endfor %}
</td></tr>
    <tr><td>location</td><td>{% if object.virtual %}
                [Virtual: {% for vm in object.dom_u.all %}<a href="/server/{{vm.dom_0.id}}">{{vm.dom_0.name}}</a>{% endfor %}]
                {% else %}
                {{ object.location.name }}
                {% endif %}</td></tr>
    <tr><td>OS</td><td><a href="/os/{{object.operating_system.family.id}}/{{object.operating_system.id}}/">{{ object.operating_system }}</a></td></tr>
    <tr><td>mem</td><td>{{ object.memory }}{% if object.swap %} [{{ object.swap }}]{% endif %}</td></tr>
    <tr><td>disk</td><td>{{ object.disk }}</td></tr>
    <tr><td>notes</td><td>{{ object.notes }}</td></tr>
    <tr>
        <td>Contacts</td>
        <td>
            {% for ac in object.servercontact_set.all %}
                <a href="/contact/{{ac.contact.id}}/">{{ac.contact.name}}</a>
                {% if request.user.is_staff %}
                    [<a href="{% url 'delete-servercontact' ac.id %}">X</a>]
                {% endif %}
            {% endfor %}
        </td>
    </tr>
</table>

{% if not object.deprecated %}
    {% if request.user.is_staff %}
        <a href="#addContact" role="button" class="btn" data-toggle="modal" data-target="#addContact">Add Contact</a>
        <form action="{% url 'add-server-contact' object.id %}" method="post">
            <div class="modal fade" id="addContact" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="myModalLabel">Add Contact</h3>
                        </div>
                        <div class="modal-body">

                            <div class="form-group">
                                <label>Contact
                                    <input type="text" name="contact" placeholder="contact" class="form-control" />
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
                            <button type="submit" class="btn btn-primary">Add Contact</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    {% endif %}
{% endif %}


{% if object.ipaddress_set.count %}
<h2>Aliases</h2>

{% if not object.deprecated %}
{% if request.user.is_staff %}
{% if object.ipaddress_set.count %}

<a href="#addAlias" role="button" class="btn" data-toggle="modal" data-target="#addAlias">Add Alias for {{object.name}}</a>

    <form action="add_alias/" method="post">
        <div class="modal fade" id="addAlias" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h3 id="myModalLabel">Add Alias for {{object.name}}</h3>
                    </div>
                    <div class="modal-body">

                        <div class="form-group">
                            <label>Hostname
                                <input type="text" name="hostname"
                                       placeholder="hostname" class="form-control" /></label>
                        </div>
                        {% ifequal object.ipaddress_set.count 1 %}
                        {% else %}
                        <div class="form-group">
                            <label>IP Address
                                <select name="ipaddress">
                                    {% for ipaddress in object.ipaddress_set.all %}
                                    <option value="{{ipaddress.id}}">{{ipaddress.ipv4}}</option>
                                    {% endfor %}
                                </select>
                            </label>
                        </div>
                        {% endifequal %}

                        <div class="form-group">
                            <label>Description
                                <textarea name="description"
                                          class="form-control"></textarea></label>
                        </div>
                        <div class="form-group">
                            <p><b>Required if a non-CU hostname:</b>
                                Please use Administrative Info field for information about
                                where the domain is registered, what account
                                it's set up with (don't enter passwords here though)
                                and who handles payments, DNS changes, etc.</p>
                            <label>Administrative Info
                                <textarea name="Administrative Info" class="form-control"></textarea></label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
                        <button class="btn btn-primary">Add Alias</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

<a href="#requestAlias" role="button" class="btn" data-toggle="modal" data-target="#requestAlias">Request new Alias for {{object.name}}</a>

    <form action="request_alias/" method="post">
        <div class="modal fade" id="requestAlias" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h3 id="myModalLabel1">Request New Alias for {{object.name}}</h3>
                    </div>
                    <div class="modal-body">
                        <p class="info">This will send an email to hostmaster with the
                            request. It may take a couple business days for the request to go
                            through. Once it does, please come back and update the status of
                            this alias from 'pending' to 'active'. </p>

                        <div class="form-group">
                            <label>Hostname
                                <input type="text" name="hostname"
                                       placeholder="hostname" class="form-control" /></label>
                        </div>
                        {% ifequal object.ipaddress_set.count 1 %}
                        {% else %}
                        <div class="form-group">
                            <label>IP Address
                                <select name="ipaddress">
                                    {% for ipaddress in object.ipaddress_set.all %}
                                    <option value="{{ipaddress.id}}">{{ipaddress.ipv4}}</option>
                                    {% endfor %}
                                </select>
                            </label>
                        </div>
                        {% endifequal %}
                        <div class="form-group">
                            <label>Description
                                <textarea name="description" class="form-control"></textarea></label>
                        </div>
                    </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Request Alias</button>
  </div>
</div>
</div>
</div>
    </form>


{% else %}
<p>Can not add aliases for a server with no IP addresses listed</p>
{% endif %}
{% endif %}
{% endif %}

<table class="table table-striped table-condensed table-bordered">
    <thead>
        <tr>
            <th>status</th>
            <th>alias</th>
            <th>description</th>
        </tr>
    </thead>

    <tbody>

{% for ipaddress in object.ipaddress_set.all %}
{% for alias in ipaddress.alias_set.all %}
        <tr class="{{alias.status_css_class}}">
            <td>
                {% if alias.is_deprecated %}
                    DEPRECATED
                {% endif %}
            </td>
            <td><a href="/alias/{{alias.id}}/">{{alias.hostname}}</a></td>
            <td>{{alias.description}}</td>
        </tr>


{% endfor %}
{% endfor %}
</tbody>
</table>
{% endif %}

{% if request.user.is_staff %}
<h2>Notes</h2>



<a href="#add-note" role="button" class="btn" data-toggle="modal" data-target="#add-note">Add Note</a>

<form action="{% url 'add-server-note' object.id %}" method="post">
    <div class="modal fade" id="add-note" tabindex="-1" role="dialog" aria-labelledby="add-note-label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="add-note-label">Add Note</h3>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <textarea name="body" class="form-control" rows="10"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            <button class="btn btn-primary">Add Note</button>
        </div>
    </div>
</div>
</div>
</form>

{% if object.servernote_set.exists %}
{% for note in object.server_notes %}
<div>
{{note.body|markdown}}
</div>
<p class="text-right text-muted">
- {{note.user.get_full_name}} @ {{note.created}}
</p>
{% endfor %}

{% endif %}
{% endif %}

{% if object.graphite_name %}
<h2>Graphs</h2>
{% with graphite_base="https://graphite.ctl.columbia.edu/render/" %}
{% with graphite_name=object.graphite_name %}
{% with width=900 height=200 %}
<ul class="nav nav-tabs">
  <li><a href="#daily" data-toggle="tab">Daily</a></li>
  <li><a href="#weekly" data-toggle="tab">Weekly</a></li>
  <li><a href="#monthly" data-toggle="tab">Monthly</a></li>
  <li><a href="#yearly" data-toggle="tab">Yearly</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="daily">
{% with from="-24hours" %}
    {% include "main/server_graphs.html" %}
{% endwith %}
  </div>
  <div class="tab-pane" id="weekly">
{% with from="-7days" %}
    {% include "main/server_graphs.html" %}
{% endwith %}
  </div>
  <div class="tab-pane" id="monthly">
{% with from="-4weeks" %}
    {% include "main/server_graphs.html" %}
{% endwith %}
  </div>
  <div class="tab-pane" id="yearly">
{% with from="-1years" %}
    {% include "main/server_graphs.html" %}
{% endwith %}
  </div>
</div>
{% endwith %}
{% endwith %}
{% endwith %}
{% endif %}


{% with grain=object.grain_info %}
    {% if grain %}
        <h2>Current Grain Info</h2>

        <h3>Summary</h3>
        {% with apps=grain.apps %}
            {% if apps %}
                <h4>apps</h4>
                <ul>
                    {% for a in grain.apps %}
                        <li>{{a}}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        {% with proxy=grain.proxy %}
            {% if proxy %}
                <h4>proxy</h4>
                <ul>
                    {% for a in grain.proxy %}
                        <li>{{a}}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        {% with roles=grain.roles %}
            {% if roles %}
                <h4>roles</h4>
                <ul>
                    {% for a in grain.roles %}
                        <li>{{a}}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        <h3>Raw JSON</h3>
        <pre>
{{grain.json}}
        </pre>
    {% else %}
        <p>No grain info for this server</p>
    {% endif %}
{% endwith %}

{% endblock %}
